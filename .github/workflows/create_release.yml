name: Create Release
on:
  workflow_dispatch:
    inputs:
      release_tag:
        required: true
        type: string

jobs:
  release:
    permissions:
      # Necessary permissions to create a release.
      contents: write
    env:
      BUILD_DIR: build
      RELEASE_BIN_ARCHIVE: release_bin.tar.gz
      RELEASE_SRC_ARCHIVE: release_src.tar.gz
      DEFAULT_BRANCH: refs/heads/${{ github.event.repository.default_branch }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      # Update the package index, then install all dependencies listed in
      # the various apt-requirements.txt files in the project.
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libpixman-1-dev
      - name: Configure
        run: |
          mkdir "$BUILD_DIR"
          cd "$BUILD_DIR"
          ../configure --target-list=riscv32-softmmu --without-default-features --enable-tcg \
            --enable-tools --enable-trace-backends=log
      - name: Build
        run: |
          cd "$BUILD_DIR"
          ninja
      - name: Create binary archive
        run: |
          ./scripts/opentitan/make_release.sh "$RELEASE_BIN_ARCHIVE" "$BUILD_DIR" .
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create \
            --target "$DEFAULT_BRANCH" \
            ${{ inputs.release_tag }} \
            --generate-notes \
            "$RELEASE_BIN_ARCHIVE#QEMU system emulator"
