name: Create Release
on:
  workflow_dispatch:
    inputs:
      release_tag:
        required: true
        type: string

jobs:
  release:
    permissions:
      # Necessary permissions to create a release.
      contents: write
    env:
      BUILD_DIR: build
      RELEASE_BIN_ARCHIVE: release_bin.tar.gz
      RELEASE_SRC_ARCHIVE: release_src.tar.gz
      DEFAULT_BRANCH: refs/heads/${{ github.event.repository.default_branch }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      # Update the package index, then install all dependencies listed in
      # the various apt-requirements.txt files in the project.
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libpixman-1-dev libgtk-3-dev
      # The meson version in ubuntu-lastest is too old so we install with with pip
      - name: Install Meson
        run: python -m pip install meson>=0.63.0
      - name: Configure
        run: |
          mkdir "$BUILD_DIR"
          cd "$BUILD_DIR"
          ../configure --target-list=riscv32-softmmu --without-default-features --enable-tcg \
            --enable-tools --enable-trace-backends=log --enable-gtk
      - name: Build
        run: |
          cd "$BUILD_DIR"
          meson -v
          meson compile
      - name: Create source code archive
        run: |
          pushd "$BUILD_DIR"
          meson dist --no-tests
          popd
          cp "$BUILD_DIR/meson-dist/qemu-$(cat VERSION).tar.xz" $RELEASE_SRC_ARCHIVE
      - name: Create binary archive
        run: |
          ./scripts/opentitan/make_release.sh "$RELEASE_BIN_ARCHIVE" "$BUILD_DIR" .
      - name: Create release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create \
            --target "$DEFAULT_BRANCH" \
            ${{ inputs.release_tag }} \
            --generate-notes \
            "$RELEASE_SRC_ARCHIVE#Source code" \
            "$RELEASE_BIN_ARCHIVE#QEMU system emulator"

      # The CRT release process renders and commits template files as part
      # of the release.  We use the github-actions bot as the author of the
      # commit.  The bot email address is discussed in this thread:
      # https://github.com/orgs/community/discussions/26560
      # - name: Publish Release
      #   env:
      #     GH_TOKEN: ${{ github.token }}
      #   run: |
      #     git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      #     git config user.name "github-actions[bot]"
      #     bazel run :release -- ${{ inputs.release_tag }}

